# BB_State 계산 분석 보고서

## 📊 요약

DB의 BB_State 계산과 Pine Script CSV의 BB_state_MTF를 비교한 결과, **데이터 소스의 차이**로 인한 불일치가 발견되었습니다.

## ✅ 검증 완료 사항

### 1. 1분봉 데이터 (100% 일치)
- **DB 1분봉** vs **Pine Script CSV 1분봉**: **완벽히 일치** (21/21개)
- 같은 시간대의 OHLC 값이 모두 동일
- 데이터 소스가 같음 (OKX API)

### 2. BB_State 계산 로직
- `_calc_bb_state()` 함수가 Pine Script와 동일한 로직으로 구현됨
- Bollinger Bands squeeze/expansion 상태 전환 로직 정상 작동
- BB_State 값 자체의 계산은 정확함

## ❌ 발견된 문제

### 1. 5분봉 데이터 불일치

**비교 결과** (20:40~21:00 구간):

| 시간 | DB 5분봉 Close | Pine 1분봉 재집계 Close | 차이 | DB BB_State | Pine BB_state_MTF | 일치 |
|------|---------------|----------------------|------|-------------|-------------------|------|
| 20:40 | 94286.20 | 94328.80 | -42.60 | 0 | 0 | ✅ |
| 20:45 | 94238.50 | 94240.00 | -1.50 | -1 | 0 | ❌ |
| 20:50 | 94191.10 | 94201.00 | -9.90 | -1 | 0 | ❌ |
| 20:55 | 94056.10 | 94194.10 | -138.00 | -1 | 0 | ❌ |
| 21:00 | 93839.60 | 94133.70 | -294.10 | -1 | 0 | ❌ |

**일치율**: 20% (1/5)

### 2. 5분봉 집계 방식 차이

#### Pine Script 방식:
```
5분 경계 시간 = T
5분봉 = 1분봉 집계 (T-5분 < time <= T-1분) + T 시간의 1분봉
```

예: 20:45 5분봉 = 20:41, 20:42, 20:43, 20:44, 20:45 (5개 1분봉)

#### DB 방식:
```
OKX API에서 직접 제공하는 5분봉 데이터 저장
(1분봉 집계가 아닌 독립적인 5분봉 캔들)
```

## 🔍 근본 원인

**데이터 소스가 다름**:
1. **DB 5분봉**: OKX API `/api/v5/market/candles?bar=5m` 에서 받아온 데이터
2. **Pine Script 5분봉**: TradingView가 1분봉을 집계해서 만든 5분봉

OKX와 TradingView의 5분봉 집계 알고리즘이 다르거나, 시간 경계 처리 방식이 달라서 발생한 차이입니다.

## 💡 해결 방안

### 방안 1: DB 1분봉으로 5분봉 BB_State 재계산 (Pine Script 방식)
**장점**:
- Pine Script CSV와 100% 일치 가능
- 백테스트 검증 용이

**단점**:
- 실전 트레이딩에서 OKX 5분봉을 사용하므로 불일치 발생
- 백테스트 결과와 실전 결과가 다를 수 있음

**구현**:
```python
# Pine Script 방식으로 5분봉 BB_State 계산
# 1. DB 1분봉 조회
# 2. Pine Script 집계 방식으로 5분봉 재구성
# 3. 재구성된 5분봉으로 BB_State 계산
# 4. bb_state_pine_script 컬럼에 저장
```

### 방안 2: 현재 DB 5분봉 BB_State 유지 (실전 방식)
**장점**:
- 실전 트레이딩과 동일한 데이터 사용
- 실전 결과와 백테스트 결과가 일치

**단점**:
- Pine Script CSV와 불일치 (하지만 이건 당연함)
- Pine Script는 검증/학습 용도로만 사용

**권장 이유**:
- **실전에서 OKX API 5분봉을 사용**하므로 DB도 같은 데이터여야 함
- Pine Script는 전략 개발/검증 단계에서만 사용
- 최종 백테스트는 DB 데이터(실전과 동일)로 수행해야 정확함

### 방안 3: 두 가지 모두 저장 (이중 검증)
**최선의 방법**:
```sql
ALTER TABLE okx_candles_5m
ADD COLUMN bb_state_okx INTEGER DEFAULT 0,      -- OKX 5분봉 기준
ADD COLUMN bb_state_resamp INTEGER DEFAULT 0;   -- 1분봉 재집계 기준
```

**장점**:
- 두 방식 모두 저장해서 차이 분석 가능
- 실전은 bb_state_okx 사용
- Pine Script 검증은 bb_state_resamp 사용

## 📋 현재 상태

### 완료된 작업:
1. ✅ BB_State 컬럼 추가 (okx_candles_1m, okx_candles_5m, okx_candles_15m)
2. ✅ BB_State 계산 및 저장 완료
   - 1분봉: 191,764개
   - 5분봉: 47,106개
   - 15분봉: 19,038개
3. ✅ 1분봉 데이터 정확성 검증 (100% 일치)
4. ✅ 5분봉 불일치 원인 파악

### 남은 작업:
1. ⏳ 5분봉 처리 방식 결정 (방안 1, 2, 3 중 선택)
2. ⏳ 15분봉 검증 (동일한 이슈 예상)
3. ⏳ MTF 값 forward fill 로직 구현 및 테스트
4. ⏳ 최종 정확도 검증

## 🎯 권장 사항

**추천: 방안 3 (두 가지 모두 저장)**

이유:
1. 실전 트레이딩에서는 `bb_state_okx` 사용 → 정확한 백테스트
2. Pine Script 검증시에는 `bb_state_resamp` 사용 → 전략 개발 신뢰도 향상
3. 두 값의 차이를 지속적으로 모니터링하여 전략 견고성 확인
4. 소량의 추가 스토리지로 큰 신뢰성 향상

## 📝 결론

- **데이터 소스 차이**로 인한 불일치이며, 계산 로직 자체는 정확함
- **실전 트레이딩 관점**에서는 현재 DB 5분봉 BB_State가 정확함
- **Pine Script 검증 관점**에서는 1분봉 재집계 방식이 필요함
- **최선의 해결책**: 두 가지 방법을 모두 구현하여 이중 검증 체계 구축
