# BACKTEST 시스템 흐름도

백테스트 엔진의 전체 데이터 흐름과 처리 과정을 설명합니다.

## 1. 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         사용자 요청                               │
│  (기간, 심볼, 타임프레임, 전략, 파라미터)                          │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BacktestEngine.run()                          │
│  - 초기화 (balance_tracker, position_manager, order_simulator)   │
│  - 심볼 정보 로드 (min_size, contract_size, tick_size)            │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   DataProvider (데이터 계층)                      │
│  ┌───────────────────────────────────────────────────────┐      │
│  │  1. TimescaleProvider.get_candles()                   │      │
│  │     - DB에서 캔들 조회                                 │      │
│  │     - 갭 감지 (_detect_gaps)                          │      │
│  │     - 갭이 있으면 → OKXProvider 호출                   │      │
│  └───────────────────────┬───────────────────────────────┘      │
│                          │                                       │
│  ┌───────────────────────▼───────────────────────────────┐      │
│  │  2. OKXProvider.get_candles()                         │      │
│  │     - CCXT로 OKX API 호출                             │      │
│  │     - 누락된 캔들 가져오기                             │      │
│  │     - 지표 계산 (RSI, ATR, EMA, SMA)                  │      │
│  └───────────────────────┬───────────────────────────────┘      │
│                          │                                       │
│  ┌───────────────────────▼───────────────────────────────┐      │
│  │  3. _save_candles_to_db()                             │      │
│  │     - DB에 영구 저장 (upsert)                          │      │
│  │     - 다음 실행 시 재사용                              │      │
│  └───────────────────────┬───────────────────────────────┘      │
│                          │                                       │
│  ┌───────────────────────▼───────────────────────────────┐      │
│  │  4. 병합 및 정렬                                       │      │
│  │     - 기존 + 새로 가져온 캔들 병합                      │      │
│  │     - 시간순 정렬, 중복 제거                           │      │
│  └───────────────────────────────────────────────────────┘      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              완전한 캔들 데이터 (갭 없음)                          │
│  [Candle1, Candle2, Candle3, ..., Candle42388]                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    캔들 순차 처리 루프                            │
│  for each candle in candles:                                    │
│      await _process_candle(candle)                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
                    (다음 섹션 참조)
```

## 2. 캔들 처리 흐름 (_process_candle)

**매 캔들마다 실행되는 핵심 로직**

```
┌─────────────────────────────────────────────────────────────────┐
│                  _process_candle(candle)                         │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
                  ┌──────────────┐
                  │ 포지션 있음?  │
                  └──────┬───────┘
                         │
           ┌─────────────┼─────────────┐
           │ YES                       │ NO
           ▼                           ▼
    ┌─────────────┐            ┌──────────────┐
    │ 포지션 관리  │            │ 시그널 체크   │
    └─────────────┘            └──────────────┘
```

### 2.1 포지션이 있을 때

```
┌─────────────────────────────────────────────────────────────────┐
│                        포지션 관리 흐름                           │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
            ┌────────────────────────────┐
            │  1. 청산 조건 체크          │
            │  _check_exit_conditions()  │
            └────────────┬───────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
  ┌─────────┐      ┌─────────┐      ┌──────────┐
  │ TP 도달  │      │ SL 도달  │      │ Trailing │
  └─────────┘      └─────────┘      │   Stop   │
        │                │           └──────────┘
        │                │                │
        └────────────────┼────────────────┘
                         │
                         ▼
              ┌──────────────────┐
              │ 청산 실행됨?      │
              └────┬─────────────┘
                   │
         ┌─────────┼─────────┐
         │ YES              │ NO
         ▼                  ▼
    ┌────────┐      ┌──────────────────┐
    │ 거래 종료│      │ 2. DCA 조건 체크 │
    │ 다음 캔들│      │ _check_dca_      │
    │        │      │  conditions()    │
    └────────┘      └────────┬─────────┘
                             │
                             ▼
                   ┌──────────────────┐
                   │ DCA 조건 충족?    │
                   └────┬─────────────┘
                        │
              ┌─────────┼─────────┐
              │ YES              │ NO
              ▼                  ▼
       ┌─────────────┐    ┌────────────────┐
       │ 추가 진입    │    │ 3. P&L 업데이트│
       │ (DCA)       │    │ 미실현 손익 계산│
       └─────────────┘    └────────┬───────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ 4. 잔고 스냅샷   │
                          │ 기록             │
                          └─────────────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ 5. Trailing Stop│
                          │ 업데이트         │
                          │ (활성화된 경우)  │
                          └─────────────────┘
```

### 2.2 포지션이 없을 때

```
┌─────────────────────────────────────────────────────────────────┐
│                        진입 시그널 체크                           │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
            ┌────────────────────────────┐
            │  1. 시그널 생성              │
            │  strategy_executor.         │
            │  generate_signal(candle)    │
            └────────────┬───────────────┘
                         │
                         ▼
              ┌──────────────────┐
              │ signal.side 존재? │
              │ (LONG/SHORT)     │
              └────┬─────────────┘
                   │
         ┌─────────┼─────────┐
         │ YES              │ NO
         ▼                  ▼
    ┌────────────┐    ┌──────────┐
    │ 진입 로직   │    │ 다음 캔들 │
    │ 실행       │    │ 스킵     │
    └─────┬──────┘    └──────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                          진입 로직                                │
├─────────────────────────────────────────────────────────────────┤
│  1. calculate_position_size()                                   │
│     - 진입 수량 계산                                              │
│     - 레버리지 결정                                               │
│     - 정밀도 반올림 (0.001 BTC)                                   │
│                                                                 │
│  2. calculate_tp_sl()                                           │
│     - TP1, TP2, TP3 계산 (ATR 기반)                              │
│     - Stop Loss 계산                                             │
│                                                                 │
│  3. order_simulator.simulate_entry()                            │
│     - 슬리피지 적용                                               │
│     - 수수료 계산                                                 │
│     - 실제 체결 가격 시뮬레이션                                    │
│                                                                 │
│  4. position_manager.open_position()                            │
│     - Position 객체 생성                                         │
│     - TP/SL 레벨 설정                                             │
│     - Partial exit 비율 설정                                      │
│                                                                 │
│  5. balance_tracker.update_balance()                            │
│     - 잔고에서 진입 비용 차감                                      │
│     - 거래 기록                                                   │
│                                                                 │
│  6. event_logger.log_entry()                                    │
│     - 진입 이벤트 로깅                                            │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 시그널 생성 로직 (Strategy Layer)

```
┌─────────────────────────────────────────────────────────────────┐
│              strategy_executor.generate_signal(candle)           │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
            ┌────────────────────────────┐
            │  1. 지표 확인               │
            │  - RSI 값                  │
            │  - ATR 값                  │
            │  - 트렌드 (EMA, SMA)        │
            └────────────┬───────────────┘
                         │
                         ▼
            ┌────────────────────────────┐
            │  2. 전략 조건 체크          │
            │  (HYPERRSI 예시)           │
            └────────────┬───────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                                 │
        ▼                                 ▼
┌────────────────┐              ┌────────────────┐
│  LONG 조건      │              │  SHORT 조건     │
├────────────────┤              ├────────────────┤
│ • RSI < 30     │              │ • RSI > 70     │
│ • 상승 트렌드   │              │ • 하락 트렌드   │
│ • '돌파' 모드   │              │ • '돌파' 모드   │
│   확인         │              │   확인         │
└────────┬───────┘              └────────┬───────┘
         │                               │
         └───────────┬───────────────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │  3. Signal 객체 생성   │
         │  - side: LONG/SHORT   │
         │  - reason: "진입 이유" │
         │  - indicators: {...}  │
         └───────────────────────┘
```

## 4. TP/SL 관리 흐름

### 4.1 Partial Exit (부분 청산)

```
┌─────────────────────────────────────────────────────────────────┐
│                      TP 레벨 도달 시                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
            ┌────────────▼────────────┐
            │  TP1 도달? (2x ATR)     │
            └────────────┬────────────┘
                         │ YES
                         ▼
            ┌────────────────────────┐
            │ • 30% 청산              │
            │ • SL → Entry (손익분기) │
            │ • 잔고 업데이트         │
            └────────────┬───────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  TP2 도달? (3x ATR)     │
            └────────────┬────────────┘
                         │ YES
                         ▼
            ┌────────────────────────┐
            │ • 30% 청산              │
            │ • SL → TP1             │
            │ • Trailing Stop 활성화  │
            └────────────┬───────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  TP3 도달? (4x ATR)     │
            │  또는 Trailing Stop     │
            └────────────┬────────────┘
                         │ YES
                         ▼
            ┌────────────────────────┐
            │ • 40% 청산 (전량)       │
            │ • 포지션 종료           │
            └────────────────────────┘
```

### 4.2 Trailing Stop

```
┌─────────────────────────────────────────────────────────────────┐
│                    Trailing Stop 로직                            │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  TP2 도달 후 활성화     │
            └────────────┬───────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  매 캔들마다:           │
            │  • 최고가 추적          │
            │  • Stop 가격 상향 조정  │
            │  • 고점 대비 -X%        │
            └────────────┬───────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  현재가 < Stop가격?     │
            └────────────┬───────────┘
                         │ YES
                         ▼
            ┌────────────────────────┐
            │  나머지 40% 전량 청산   │
            │  ExitReason:           │
            │  TRAILING_STOP         │
            └────────────────────────┘
```

## 5. DCA (Dollar Cost Averaging) 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    _check_dca_conditions()                       │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  조건 1: 파라미터 확인  │
            │  • pyramiding_enabled? │
            │  • pyramiding_limit?   │
            └────────────┬───────────┘
                         │ YES
                         ▼
            ┌────────────────────────┐
            │  조건 2: RSI 조건       │
            │  • LONG: RSI < 30      │
            │  • SHORT: RSI > 70     │
            └────────────┬───────────┘
                         │ YES
                         ▼
            ┌────────────────────────┐
            │  조건 3: 트렌드 조건    │
            │  • EMA vs SMA          │
            └────────────┬───────────┘
                         │ YES
                         ▼
            ┌────────────────────────┐
            │  조건 4: 가격 레벨      │
            │  • 이전 진입가 대비     │
            │  • dca_price_distance% │
            └────────────┬───────────┘
                         │ YES
                         ▼
            ┌────────────────────────┐
            │  조건 5: 진입 횟수      │
            │  • entry_count <       │
            │    pyramiding_limit    │
            └────────────┬───────────┘
                         │ YES
                         ▼
            ┌────────────────────────┐
            │  DCA 진입 실행          │
            │  • 평균 단가 재계산     │
            │  • TP/SL 재설정         │
            │  • entry_count++       │
            └────────────────────────┘
```

## 6. 갭 채우기 시스템

```
┌─────────────────────────────────────────────────────────────────┐
│              TimescaleProvider.get_candles()                     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  1. DB에서 캔들 조회    │
            └────────────┬───────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  2. _detect_gaps()     │
            │  • 시간 간격 체크       │
            │  • 10% 허용 오차        │
            └────────────┬───────────┘
                         │
                         ▼
              ┌──────────────────┐
              │ 갭 발견?          │
              └────┬─────────────┘
                   │
         ┌─────────┼─────────┐
         │ YES              │ NO
         ▼                  ▼
┌────────────────┐    ┌──────────┐
│ 갭 채우기      │    │ 반환     │
└────┬───────────┘    └──────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────────────┐
│                      갭 채우기 상세 흐름                          │
├─────────────────────────────────────────────────────────────────┤
│  1. _detect_and_fill_gaps()                                     │
│     for each gap:                                               │
│       gap_start = prev_candle.timestamp + timeframe_delta       │
│       gap_end = curr_candle.timestamp                           │
│                                                                 │
│  2. OKXProvider.get_candles(gap_start, gap_end)                 │
│     • CCXT로 OKX API 호출                                        │
│     • 페이지네이션 처리 (300개씩)                                 │
│     • RSI, ATR, EMA, SMA 계산                                    │
│                                                                 │
│  3. _save_candles_to_db()                                       │
│     INSERT ... ON CONFLICT DO UPDATE                            │
│     • 영구 저장 (다음 실행 시 재사용)                             │
│                                                                 │
│  4. 병합 및 정렬                                                 │
│     • 기존 + 새 캔들 병합                                         │
│     • timestamp 기준 정렬                                        │
│     • 중복 제거                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 7. 백테스트 결과 생성

```
┌─────────────────────────────────────────────────────────────────┐
│              모든 캔들 처리 완료 후                                │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  1. 미청산 포지션 처리  │
            │  • 마지막 가격으로      │
            │    미실현 손익 계산     │
            └────────────┬───────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  2. BacktestResult 생성│
            └────────────┬───────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BacktestResult 구성                           │
├─────────────────────────────────────────────────────────────────┤
│  기본 정보:                                                      │
│  • user_id, symbol, timeframe                                   │
│  • start_date, end_date                                         │
│  • strategy_name, strategy_params                               │
│                                                                 │
│  성과 지표:                                                      │
│  • total_trades (총 거래 수)                                     │
│  • win_rate (승률)                                               │
│  • total_pnl (총 손익)                                           │
│  • total_return_percent (수익률 %)                               │
│  • max_drawdown (최대 손실)                                      │
│  • sharpe_ratio (샤프 비율)                                      │
│                                                                 │
│  잔고 정보:                                                      │
│  • initial_balance (초기 잔고)                                   │
│  • final_balance (최종 잔고)                                     │
│  • unrealized_pnl (미실현 손익)                                  │
│                                                                 │
│  거래 내역:                                                      │
│  • trades: List[Trade]                                          │
│    - entry_time, exit_time                                      │
│    - entry_price, exit_price                                    │
│    - quantity, leverage                                         │
│    - pnl, pnl_percent                                           │
│    - exit_reason (TP1/TP2/TP3/SL/TRAILING_STOP)                │
│                                                                 │
│  잔고 히스토리:                                                   │
│  • balance_history: List[BalanceSnapshot]                       │
│    - timestamp                                                  │
│    - balance                                                    │
│    - unrealized_pnl                                             │
│                                                                 │
│  실행 정보:                                                      │
│  • execution_time_seconds                                       │
│  • completed_at                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 8. 데이터 구조

### Candle 객체

```python
class Candle:
    timestamp: datetime      # 캔들 시간
    symbol: str             # 심볼
    timeframe: str          # 타임프레임 (5m, 15m, etc)

    # OHLCV
    open: float
    high: float
    low: float
    close: float
    volume: float

    # 지표 (미리 계산됨)
    rsi: Optional[float]
    atr: Optional[float]
    ema: Optional[float]    # 7-period EMA
    sma: Optional[float]    # 20-period SMA

    # 메타데이터
    data_source: str        # "timescaledb" or "okx_api"
    is_complete: bool
```

### Position 객체

```python
class Position:
    side: TradeSide         # LONG or SHORT
    entry_price: float      # 평균 진입가
    quantity: float         # 수량
    leverage: int           # 레버리지

    # TP/SL 레벨
    take_profit_levels: List[TPLevel]  # [TP1, TP2, TP3]
    stop_loss: float

    # Trailing Stop
    trailing_stop_activated: bool
    trailing_stop_price: Optional[float]
    highest_price: Optional[float]

    # DCA 정보
    entry_count: int        # 진입 횟수

    # 손익
    unrealized_pnl: float
    unrealized_pnl_percent: float
```

### Trade 객체

```python
class Trade:
    entry_time: datetime
    exit_time: datetime

    side: TradeSide
    entry_price: float
    exit_price: float
    quantity: float
    leverage: int

    pnl: float              # 실현 손익
    pnl_percent: float      # 손익률

    exit_reason: ExitReason  # TP1/TP2/TP3/SL/TRAILING_STOP
    entry_count: int         # DCA 진입 횟수
```

## 9. 주요 파라미터

### 전략 파라미터 (HYPERRSI 예시)

```python
strategy_params = {
    # 진입 조건
    "entry_rsi_mode": "돌파",           # "일반" or "돌파"
    "long_rsi_threshold": 30,
    "short_rsi_threshold": 70,

    # TP/SL
    "tp_mode": "ATR",                   # "고정" or "ATR"
    "tp1_atr_multiplier": 2.0,
    "tp2_atr_multiplier": 3.0,
    "tp3_atr_multiplier": 4.0,
    "stop_loss_atr_multiplier": 1.5,

    # Partial Exit
    "tp1_close_percent": 30,
    "tp2_close_percent": 30,
    "tp3_close_percent": 40,

    # Break-even
    "breakeven_enabled": True,

    # Trailing Stop
    "trailing_stop_enabled": True,
    "trailing_activation_percent": 3.0,
    "trailing_stop_percent": 2.0,

    # DCA/Pyramiding
    "pyramiding_enabled": True,
    "pyramiding_limit": 3,
    "dca_rsi_threshold": 30,
    "dca_price_distance_percent": 2.0,

    # 포지션 사이즈
    "position_size_percent": 100,
    "leverage": 1,
}
```

## 10. 성능 최적화

### 데이터 로딩

- **일괄 조회**: 전체 기간의 캔들을 한 번에 조회
- **DB 인덱싱**: `(symbol, time)` 복합 인덱스
- **갭 채우기 캐싱**: 한 번 채운 갭은 DB에 영구 저장

### 처리 성능

- **지표 사전 계산**: DB에 RSI, ATR 등 저장
- **NULL 지표 감지**: 누락된 지표만 재계산
- **배치 업데이트**: 1000개씩 묶어서 DB 업데이트

### 메모리 관리

- **스트리밍 처리**: 캔들을 순차적으로 처리 (메모리 효율)
- **이벤트 로깅 선택**: `enable_event_logging=False`로 비활성화 가능

## 11. 에러 처리

```
┌─────────────────────────────────────────────────────────────────┐
│                      에러 처리 흐름                               │
├─────────────────────────────────────────────────────────────────┤
│  데이터 없음:                                                     │
│  • validate_data_availability() 체크                             │
│  • 커버리지 < 90% → 경고 로그                                     │
│  • 커버리지 < 50% → ValueError 발생                               │
│                                                                 │
│  OKX API 실패:                                                   │
│  • 기존 DB 데이터로 계속 진행                                      │
│  • 갭은 남지만 백테스트는 실행                                     │
│  • 로그에 갭 정보 기록                                            │
│                                                                 │
│  전략 실행 오류:                                                  │
│  • try-except로 캔들 스킵                                         │
│  • 오류 로그 기록                                                 │
│  • 다음 캔들 계속 처리                                            │
│                                                                 │
│  포지션 관리 오류:                                                │
│  • 잔고 부족 → 진입 스킵                                          │
│  • 수량 부족 → 최소 수량으로 조정                                  │
│  • 로그 기록 후 계속 진행                                         │
└─────────────────────────────────────────────────────────────────┘
```

## 12. 실행 예시

```python
from BACKTEST.engine import BacktestEngine
from BACKTEST.data import TimescaleProvider
from BACKTEST.strategies import HyperRSIStrategy
from datetime import datetime, timezone
from uuid import uuid4

# 1. 초기화
provider = TimescaleProvider()
engine = BacktestEngine(
    data_provider=provider,
    initial_balance=10000.0,
    fee_rate=0.0005,
    slippage_percent=0.05
)

# 2. 전략 설정
strategy = HyperRSIStrategy(strategy_params)

# 3. 백테스트 실행
result = await engine.run(
    user_id=uuid4(),
    symbol="BTC-USDT-SWAP",
    timeframe="5m",
    start_date=datetime(2025, 6, 1, tzinfo=timezone.utc),
    end_date=datetime(2025, 11, 1, tzinfo=timezone.utc),
    strategy_name="HYPERRSI",
    strategy_params=strategy_params,
    strategy_executor=strategy
)

# 4. 결과 확인
print(f"총 거래: {result.total_trades}")
print(f"승률: {result.win_rate:.1f}%")
print(f"수익률: {result.total_return_percent:.2f}%")
print(f"최종 잔고: {result.final_balance:.2f} USDT")

await provider.close()
```

---

## 요약

1. **완전한 데이터**: TimescaleDB + OKX API로 갭 없는 캔들 데이터 보장
2. **모든 캔들 순회**: 42,388개 캔들을 하나씩 처리 (실시간과 동일)
3. **전략 시그널**: 매 캔들마다 시그널 체크, 조건 충족 시만 진입
4. **포지션 관리**: TP/SL, Trailing Stop, DCA를 실시간처럼 시뮬레이션
5. **영구 캐싱**: 한 번 채운 갭은 DB에 저장되어 재사용
